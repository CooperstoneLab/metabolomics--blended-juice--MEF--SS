---
title: "Metabolomic - Statistics - Positive mode - MEF"
author: "Giovana Domeneghini Mercali"
prefer-html: true
format: gfm
---

### Load libraries
```{r, message = FALSE, warning = FALSE}
library(factoextra) # visualizing PCA results
library(glue) # for easy pasting
library(plotly) # quick interactive plots
library(proxyC) # more efficient large matrices
library(data.table) # easy transposing
library(janitor) # for cleaning names and checking duplicates
library(notame) # for collapsing ions coming from the same metabolite
library(doParallel) # for parallelizing notame specifically
library(patchwork) # for making multi-panel plots
library(rstatix) # for additional univariate functionality
library(readxl)
library(svglite)
library(pheatmap)

# this is at the end hoping that the default select will be that from dplyr
library(tidyverse) # for everything
```

## Read in data

Positive mode.

```{r}
# read in metabolomics data
feature_table_long <- read_csv("features_clustered_long__pos_MEF.csv",
                  trim_ws = TRUE,
                  na = "0") # read in 0s to be NAs.

# read in meta data
metadata <- read_csv("metadata_pos_mef.csv",
                  trim_ws = TRUE)

# read in meta data
annotation <- read_csv("Annotation_pos.csv", 
                  locale=locale(encoding = "latin1"))

```

Take a quick look at our data.

```{r}
# look at first 5 rows, first 5 columns 
feature_table_long[1:5,1:5]

# look at first 5 rows, all columns 
metadata[1:5,]

# check dimensions
dim(feature_table_long)
dim(metadata)
```

First we are going to convert the type of some of the columns to match what we want (e.g., run order converted to numeric, treatment to factor).

```{r}
tibble(feature_table_long)

# make run_order numeric
feature_table_long$run_order <- as.numeric(feature_table_long$run_order)

# make treatment and sample_or_qc a factor (i.e., categorical)
feature_table_long$treatment <- as.factor(feature_table_long$treatment)
feature_table_long$sample_or_qc <- as.factor(feature_table_long$sample_or_qc)

# did it work?
tibble(feature_table_long)
```

## Data quality

#### Log2 transformed

We will log2 transform our data.

```{r}
feature_table_long_log2 <- feature_table_long %>%
  mutate(rel_abund = log2(rel_abund))
```

And then plot.

```{r}
boxplot_log2_transformed <- feature_table_long_log2 %>%
  ggplot(aes(x = sample_name, y = rel_abund, fill = treatment)) +
  geom_boxplot(alpha = 0.6) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_manual(values = c("FJ" = "#F28EAD", 
                                "MT" = "#C77CDB",
                                "MEF" = "#A8D8B9", 
                                "MEF+SS" = "#7FB3D5",
                                "QC" = "#F6A900")) +
  labs(y = "Relative abundance", x = "Sample", 
  title = "LC-MS (+) feature abundances by Sample",
       subtitle = "Data is log2 transformed")
```


We can also look at this data by run order to see if we have any overall run order effects visible.

```{r}
boxplot_log2_transformed_run_order <-feature_table_long_log2 %>%
  mutate(sample_name = fct_reorder(sample_name, run_order)) %>%
  ggplot(aes(x = sample_name , y = rel_abund, fill = treatment)) +
  geom_boxplot(alpha = 0.6) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90)) +
  scale_fill_manual(values = c("FJ" = "#F28EAD", 
                                "MT" = "#C77CDB",
                                "MEF" = "#A8D8B9", 
                                "MEF+SS" = "#7FB3D5",
                                "QC" = "#F6A900")) +
  labs(y = "Relative abundance", x = "Sample")
```

```{r}
boxplot <- boxplot_log2_transformed / boxplot_log2_transformed_run_order + plot_annotation(tag_levels = c("A"))

ggsave(plot = boxplot,
       filename = "boxplot_final_pos.svg")
```



Let's write out that data as our final feature table used for the rest of the analysis.

```{r}
feature_table_wide_log2 <- feature_table_long_log2 %>%
  select(-mz, -rt) %>%
  pivot_wider(names_from = mz_rt,
              values_from = rel_abund)

write_csv(feature_table_wide_log2,
          file = "feature_table_wide_log2_pos.csv")
```


## PCAs all data

### With QCs

```{r}
pca_qc <- prcomp(feature_table_wide_log2[,-c(1:4)], # remove metadata
                 scale = FALSE, # we did our own scaling
                 center = TRUE) # true is the default

summary(pca_qc)
```

Look at how much variance is explained by each PC.
```{r}
importance_qc <- summary(pca_qc)$importance %>%
  as.data.frame()

head(importance_qc)
```

Generate a scree plot.
```{r}
fviz_eig(pca_qc)
```

Generate a scores plot (points are samples) quickly with `fviz_pca_ind`.
```{r}
fviz_pca_ind(pca_qc)
```

Make a scores plot but prettier.
```{r}
# create a df of pca_qc$x
scores_raw_qc <- as.data.frame(pca_qc$x)

# bind meta-data
scores_qc <- bind_cols(feature_table_wide_log2[,1:4], # first 4 columns
                       scores_raw_qc)
```

Plot.
```{r}
# create objects indicating percent variance explained by PC1 and PC2
PC1_percent_qc <- round((importance_qc[2,1])*100, # index 2nd row, 1st column, times 100
                         1) # round to 1 decimal
PC2_percent_qc <- round((importance_qc[2,2])*100, 1) 

# plot
# aes(text) is for setting tooltip with plotly later to indicate hover text
(scores_qc_plot <- scores_qc %>%
  ggplot(aes(x = PC1, y = PC2, fill = treatment, text = glue("Sample: {sample_name},
                                                           Treatment: {treatment}"))) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_point(shape = 21, size = 3, color = "black") +
  theme_minimal() +
  scale_fill_manual(values = c("FJ" = "#F28EAD", 
                                "MT" = "#C77CDB",
                                "MEF" = "#A8D8B9", 
                                "MEF+SS" = "#7FB3D5",
                                "QC" = "#F6A900")) +
  labs(x = glue("PC1: {PC1_percent_qc}%"), 
       y = glue("PC2: {PC2_percent_qc}%"), 
       title = "", tag = "B"))
```

Then make your scores plot interactive so you can see who is who.

```{r}
ggplotly(scores_qc_plot, tooltip = "text")
```

```{r}
ggsave(plot = scores_qc_plot,
       filename = "pca_qc_final_pos.jpeg", width = 140, height = 120, units = "mm")
```

Make a loadings plot (points are features) even though it might not be that useful.

```{r}
fviz_pca_var(pca_qc)
```

See what I mean? Not that useful. There are some functions in PCAtools that label only the points that most contribute to each PC. Could also do this manually if its of interest.

### Without QCs

```{r}
feature_table_wide_log2_noqc <- feature_table_wide_log2 %>%
  filter(sample_or_qc == "Sample")


pca_noqc <- prcomp(feature_table_wide_log2_noqc[,-c(1:4)], # remove metadata
                 scale = FALSE, # we did our own scaling
                 center = TRUE) # true is the default

summary(pca_noqc)
```

Look at how much variance is explained by each PC.

```{r}
importance_noqc <- summary(pca_noqc)$importance %>%
  as.data.frame()

head(importance_noqc)
```

Generate a scree plot.

```{r}
fviz_eig(pca_noqc)
```

Generate a scores plot (points are samples) quickly with `fviz_pca_ind`.

```{r}
fviz_pca_ind(pca_noqc)
```

Make a scores plot but prettier.

```{r}
# create a df of pca_qc$x
scores_raw_noqc <- as.data.frame(pca_noqc$x)

# bind meta-data
scores_noqc <- bind_cols(feature_table_wide_log2_noqc[,1:4], # metadata
                         scores_raw_noqc)
```

Plot.

```{r}
# create objects indicating percent variance explained by PC1 and PC2
PC1_percent_noqc <- round((importance_noqc[2,1])*100, # index 2nd row, 1st column, times 100
                         1) # round to 1 decimal
PC2_percent_noqc <- round((importance_noqc[2,2])*100, 1) 

# plot
# aes(text) is for setting tooltip with plotly later to indicate hover text
(scores_noqc_plot <- scores_noqc %>%
  ggplot(aes(x = PC1, y = PC2, fill = treatment, text = glue("Sample: {sample_name},
                                                             Treatment: {treatment}"))) +
  geom_hline(yintercept = 0, linetype = "dashed") +
  geom_vline(xintercept = 0, linetype = "dashed") +
  geom_point(shape = 21, size = 3, color = "black") +
  theme_minimal() +
  scale_fill_manual(values = c("FJ" = "#F28EAD", 
                                "MT" = "#C77CDB",
                                "MEF" = "#A8D8B9", 
                                "MEF+SS" = "#7FB3D5",
                                "QC" = "#F6A900")) +
  labs(x = glue("PC1: {PC1_percent_noqc}%"), 
       y = glue("PC2: {PC2_percent_noqc}%"), 
       title = "", tag = "B"))
```

Then make your scores plot ineractive so you can see who is who.

```{r}
ggsave(plot = scores_noqc_plot,
       filename = "pca_noqc_final_pos.jpeg", width = 140, height = 120, units = "mm")
```

```{r}
ggsave(plot = scores_noqc_plot,
       filename = "pca_noqc_final_pos.svg")
```


Make a loadings plot (points are features) even though it might not be that useful.

```{r}
fviz_pca_var(pca_noqc)
```

See what I mean? Not that useful. There are some functions in PCAtools that label only the points that most contribute to each PC. Could also do this manually if its of interest.

## Add annotations

```{r}
feature_table_long_log2 <- left_join(feature_table_long_log2, annotation, by = "mz_rt")
  
unique(feature_table_long_log2$Compound)

feature_table_long_log2 <- feature_table_long_log2 %>%
  mutate(id = if_else(is.na(Compound), mz_rt, Compound))
  
```
```{r}
write_csv(feature_table_long_log2,
          file = "feature_table_long_log2__annotated_pos.csv")
```


## Univariate Testing

I am going to include some sample univariate testing for comparisons between two and more than two groups.

### Fresh x MEF

#### Parametric

Getting an error that some data is essential constant, checked for which features have 0 SD across the treatments for comparison.

```{r}
# find which features have no variance across fresh juice and MEF
freshjuice_MEF_novariance <- feature_table_long_log2 %>%
  filter(treatment == "FJ" | treatment == "MEF") %>%
  dplyr::select(sample_name, treatment, mz_rt, rel_abund, id) %>%
  group_by(id) %>%
  summarize(stdev = sd(rel_abund),
            mean = mean(rel_abund)) %>%
  filter(stdev == 0)

# create a vector of those features with no variance
freshjuice_MEF_toremove <- freshjuice_MEF_novariance$id

# investigating one of the features that has zero variance  
feature_table_long_log2 %>%
  filter(mz_rt == "116.0352_0.9495") %>%
  dplyr::select(sample_name, treatment, mz_rt, rel_abund, id) %>%
  group_by(treatment) %>%
  summarize(stdev = sd(rel_abund),
            mean = mean(rel_abund))  

# run series of t-tests
freshjuice_MEF <- feature_table_long_log2 %>%
  filter(treatment == "FJ" | treatment == "MEF") %>%
  filter(!mz_rt %in% freshjuice_MEF_toremove) %>% # remove features with 0 variance
  dplyr::select(sample_name, treatment, mz_rt, rel_abund, id) %>%
  group_by(id) %>%
  t_test(rel_abund ~ treatment, 
         paired = FALSE, 
         detailed = TRUE, # gives you more detail in output
         p.adjust.method = "BH") %>% # bonferroni or Benjamini-Hochberg false discovery rate multiple testing correction
  add_significance()

# extract out only the significantly different features
freshjuice_MEF_bonferroni <- freshjuice_MEF %>%
  filter(p <= 0.05)

# how many features are significantly different between the groups?
nrow(freshjuice_MEF_bonferroni)
```

#### Volcano plot

Wrangling

```{r}
freshjuice_MEF_FC <- feature_table_long_log2 %>%
  filter(treatment == "FJ" | treatment == "MEF") %>%
  group_by(treatment, id) %>%
  summarize(mean = mean(rel_abund)) %>%
  pivot_wider(names_from = treatment, values_from = mean) %>%
  mutate(freshjuice_minus_MEF_log2 = `FJ`-MEF)

freshjuice_MEF_FC_pval <- right_join(freshjuice_MEF_FC, freshjuice_MEF, by = "id") %>%
  mutate(neglog10p = -log10(p))
```

Looking at features that are at least 2 fold change between groups and significantly different at p<0.05.

```{r}
higher_freshjuice <- freshjuice_MEF_FC_pval %>%
  filter(neglog10p >= 1.3 & freshjuice_minus_MEF_log2 >= 1)

higher_MEF <- freshjuice_MEF_FC_pval %>%
  filter(neglog10p >= 1.3 & freshjuice_minus_MEF_log2 <= -1)

(freshjuice_MEF_volcano <- freshjuice_MEF_FC_pval %>%
  ggplot(aes(x = freshjuice_minus_MEF_log2, y = neglog10p, text = id)) +
  geom_point() +
  geom_point(data = higher_freshjuice, 
             aes(x = freshjuice_minus_MEF_log2, y = neglog10p),
             color = "red") +
  geom_point(data = higher_MEF, 
             aes(x = freshjuice_minus_MEF_log2, y = neglog10p),
             color = "blue") +
  geom_hline(yintercept = 1.3, linetype = "dashed") +
  geom_vline(xintercept = -1, linetype = "dashed") +
  geom_vline(xintercept = 1, linetype = "dashed") +
  coord_cartesian(xlim = c(-8,8)) +
  theme_minimal(base_size = 8) +
  labs(x = "-log2(fold change)", base_size = 8,
       y = "-log10(p-value)", base_size = 8,
       title = "FJ vs MEF", tag = "B", base_size = 8))
```

Make interactive.

```{r}
ggplotly(freshjuice_MEF_volcano, tooltip = "text")
```

Saving higher_freshjuice and higher_MEF files

```{r}
write_csv(higher_freshjuice,
          "pos_higher_freshjuice_versus_MEF.csv")

write_csv(higher_MEF,
          "pos_higher_MEF_versus_freshjuice.csv")
```

#### Non-parametric

Data might not be normally distributed so I did a nonparametric test.

```{r}

# run series of t-tests
freshjuice_MEF_nonparametric <- feature_table_long_log2 %>%
  filter(treatment == "FJ" | treatment == "MEF") %>%
  filter(!mz_rt %in% freshjuice_MEF_toremove) %>% # remove features with 0 variance
  dplyr::select(sample_name, treatment, mz_rt, rel_abund) %>%
  group_by(mz_rt) %>%
  wilcox_test(rel_abund ~ treatment, 
         paired = FALSE, 
         detailed = TRUE, # gives you more detail in output
         p.adjust.method = "BH") %>% # Benjamini-Hochberg false discovery rate multiple testing correction
  add_significance() %>%
  arrange(p)

# extract out only the significantly different features
freshjuice_MEF_nonparametric_sig <- freshjuice_MEF_nonparametric %>%
  filter(p <= 0.05)

# how many features are significantly different between the groups?
nrow(freshjuice_MEF_nonparametric_sig)
```

### Freshjuice x MEF_SS


#### Parametric

Getting an error that some data is essential constant, checked for which features have 0 SD across the treatments for comparison.

```{r}
# find which features have no variance across fresh juice and MEF_SS
freshjuice_MEF_SS_novariance <- feature_table_long_log2 %>%
  filter(treatment == "FJ" | treatment == "MEF+SS") %>%
  dplyr::select(sample_name, treatment, mz_rt, rel_abund, id) %>%
  group_by(id) %>%
  summarize(stdev = sd(rel_abund),
            mean = mean(rel_abund)) %>%
  filter(stdev == 0)

# create a vector of those features with no variance
freshjuice_MEF_SS_toremove <- freshjuice_MEF_SS_novariance$id

# investigating one of the features that has zero variance  
feature_table_long_log2 %>%
  filter(mz_rt == "116.0352_0.9495") %>%
  dplyr::select(sample_name, treatment, mz_rt, rel_abund, id) %>%
  group_by(treatment) %>%
  summarize(stdev = sd(rel_abund),
            mean = mean(rel_abund))  

# run series of t-tests
freshjuice_MEF_SS <- feature_table_long_log2 %>%
  filter(treatment == "FJ" | treatment == "MEF+SS") %>%
  filter(!mz_rt %in% freshjuice_MEF_SS_toremove) %>% # remove features with 0 variance
  dplyr::select(sample_name, treatment, mz_rt, rel_abund, id) %>%
  group_by(id) %>%
  t_test(rel_abund ~ treatment, 
         paired = FALSE, 
         detailed = TRUE, # gives you more detail in output
         p.adjust.method = "BH") %>% # bonferroni or Benjamini-Hochberg false discovery rate multiple testing correction
  add_significance()

# extract out only the significantly different features
freshjuice_MEF_SS_bonferroni <- freshjuice_MEF_SS %>%
  filter(p <= 0.05)

# how many features are significantly different between the groups?
nrow(freshjuice_MEF_SS_bonferroni)
```

#### Volcano plot

Wrangling
```{r}
freshjuice_MEF_SS_FC <- feature_table_long_log2 %>%
  filter(treatment == "FJ" | treatment == "MEF+SS") %>%
  group_by(treatment, id) %>%
  summarize(mean = mean(rel_abund)) %>%
  pivot_wider(names_from = treatment, values_from = mean) %>%
  mutate(freshjuice_minus_MEF_SS_log2 = `FJ`-`MEF+SS`)

freshjuice_MEF_SS_FC_pval <- right_join(freshjuice_MEF_SS_FC, freshjuice_MEF_SS, by = "id") %>%
  mutate(neglog10p = -log10(p))
```

Looking at features that are at least 2 fold change between groups and significantly different at p<0.05.
```{r}
higher_freshjuice <- freshjuice_MEF_SS_FC_pval %>%
  filter(neglog10p >= 1.3 & freshjuice_minus_MEF_SS_log2 >= 1)

higher_MEF_SS <- freshjuice_MEF_SS_FC_pval %>%
  filter(neglog10p >= 1.3 & freshjuice_minus_MEF_SS_log2 <= -1)

(freshjuice_MEF_SS_volcano <- freshjuice_MEF_SS_FC_pval %>%
  ggplot(aes(x = freshjuice_minus_MEF_SS_log2, y = neglog10p, text = id)) +
  geom_point() +
  geom_point(data = higher_freshjuice, 
             aes(x = freshjuice_minus_MEF_SS_log2, y = neglog10p),
             color = "red") +
  geom_point(data = higher_MEF_SS, 
             aes(x = freshjuice_minus_MEF_SS_log2, y = neglog10p),
             color = "blue") +
  geom_hline(yintercept = 1.3, linetype = "dashed") +
  geom_vline(xintercept = -1, linetype = "dashed") +
  geom_vline(xintercept = 1, linetype = "dashed") +
  coord_cartesian(xlim = c(-8,8)) +
  theme_minimal(base_size = 8) +
  labs(x = "-log2(fold change)", base_size = 8,
       y = "-log10(p-value)", base_size = 8,
       title = "FJ vs MEF+SS", tag = "B", base_size = 8))
```

Make interactive.
```{r}
ggplotly(freshjuice_MEF_SS_volcano, tooltip = "text")
```

Saving higher_freshjuice and higher_MEF_SS files

```{r}
write_csv(higher_freshjuice,
          "pos_higher_freshjuice_versus_MEF_SS.csv")

write_csv(higher_MEF_SS,
          "pos_higher_MEF_SS_versus_freshjuice.csv")
```

#### Non-parametric

Data might not be normally distributed so I did a nonparametric test.

```{r}

# run series of t-tests
freshjuice_MEF_SS_nonparametric <- feature_table_long_log2 %>%
  filter(treatment == "FJ" | treatment == "MEF+SS") %>%
  filter(!mz_rt %in% freshjuice_MEF_SS_toremove) %>% # remove features with 0 variance
  dplyr::select(sample_name, treatment, mz_rt, rel_abund) %>%
  group_by(mz_rt) %>%
  wilcox_test(rel_abund ~ treatment, 
         paired = FALSE, 
         detailed = TRUE, # gives you more detail in output
         p.adjust.method = "BH") %>% # Benjamini-Hochberg false discovery rate multiple testing correction
  add_significance() %>%
  arrange(p)

# extract out only the significantly different features
freshjuice_MEF_SS_nonparametric_sig <- freshjuice_MEF_SS_nonparametric %>%
  filter(p <= 0.05)

# how many features are significantly different between the groups?
nrow(freshjuice_MEF_SS_nonparametric_sig)
```

### MEF x MEF_SS


#### Parametric

Getting an error that some data is essential constant, checked for which features have 0 SD across the treatments for comparison.

```{r}
# find which features have no variance across MEF and MEF_SS
MEF_MEF_SS_novariance <- feature_table_long_log2 %>%
  filter(treatment == "MEF" | treatment == "MEF+SS") %>%
  dplyr::select(sample_name, treatment, mz_rt, rel_abund, id) %>%
  group_by(id) %>%
  summarize(stdev = sd(rel_abund),
            mean = mean(rel_abund)) %>%
  filter(stdev == 0)

# create a vector of those features with no variance
MEF_MEF_SS_toremove <- MEF_MEF_SS_novariance$id

# investigating one of the features that has zero variance  
feature_table_long_log2 %>%
  filter(mz_rt == "116.0352_0.9495") %>%
  dplyr::select(sample_name, treatment, mz_rt, rel_abund, id) %>%
  group_by(treatment) %>%
  summarize(stdev = sd(rel_abund),
            mean = mean(rel_abund))  

# run series of t-tests
MEF_MEF_SS <- feature_table_long_log2 %>%
  filter(treatment == "MEF" | treatment == "MEF+SS") %>%
  filter(!mz_rt %in% MEF_MEF_SS_toremove) %>% # remove features with 0 variance
  dplyr::select(sample_name, treatment, mz_rt, rel_abund, id) %>%
  group_by(id) %>%
  t_test(rel_abund ~ treatment, 
         paired = FALSE, 
         detailed = TRUE, # gives you more detail in output
         p.adjust.method = "BH") %>% # bonferroni or Benjamini-Hochberg false discovery rate multiple testing correction
  add_significance()

# extract out only the significantly different features
MEF_MEF_SS_bonferroni <- MEF_MEF_SS %>%
  filter(p <= 0.05)

# how many features are significantly different between the groups?
nrow(MEF_MEF_SS_bonferroni)
```

#### Volcano plot

Wrangling

```{r}
MEF_MEF_SS_FC <- feature_table_long_log2 %>%
  filter(treatment == "MEF" | treatment == "MEF+SS") %>%
  group_by(treatment, id) %>%
  summarize(mean = mean(rel_abund)) %>%
  pivot_wider(names_from = treatment, values_from = mean) %>%
  mutate(MEF_minus_MEF_SS_log2 = MEF-`MEF+SS`)

MEF_MEF_SS_FC_pval <- right_join(MEF_MEF_SS_FC, MEF_MEF_SS, by = "id") %>%
  mutate(neglog10p = -log10(p))
```

Looking at features that are at least 2 fold change between groups and significantly different at p<0.05.
```{r}
higher_MEF <- MEF_MEF_SS_FC_pval %>%
  filter(neglog10p >= 1.3 & MEF_minus_MEF_SS_log2 >= 1)

higher_MEF_SS <- MEF_MEF_SS_FC_pval %>%
  filter(neglog10p >= 1.3 & MEF_minus_MEF_SS_log2 <= -1)

(MEF_MEF_SS_volcano <- MEF_MEF_SS_FC_pval %>%
  ggplot(aes(x = MEF_minus_MEF_SS_log2, y = neglog10p, text = id)) +
  geom_point() +
  geom_point(data = higher_MEF, 
             aes(x = MEF_minus_MEF_SS_log2, y = neglog10p),
             color = "red") +
  geom_point(data = higher_MEF_SS, 
             aes(x = MEF_minus_MEF_SS_log2, y = neglog10p),
             color = "blue") +
  geom_hline(yintercept = 1.3, linetype = "dashed") +
  geom_vline(xintercept = -1, linetype = "dashed") +
  geom_vline(xintercept = 1, linetype = "dashed") +
  coord_cartesian(xlim = c(-8,8)) +
  theme_minimal(base_size = 8) +
  labs(x = "-log2(fold change)", base_size = 8,
       y = "-log10(p-value)", base_size = 8,
       title = "MEF vs MEF+SS", tag = "B", base_size = 8))
```

Make interactive.
```{r}
ggplotly(MEF_MEF_SS_volcano, tooltip = "text")
```

Saving higher_MEF and higher_MEF_SS files

```{r}
write_csv(higher_MEF,
          "pos_higher_MEF_versus_MEF_SS.csv")

write_csv(higher_MEF_SS,
          "pos_higher_MEF_SS_versus_MEF.csv")
```


#### Non-parametric

Data might not be normally distributed so I did a nonparametric test.

```{r}

# run series of t-tests
MEF_MEF_SS_nonparametric <- feature_table_long_log2 %>%
  filter(treatment == "MEF" | treatment == "MEF+SS") %>%
  filter(!mz_rt %in% MEF_MEF_SS_toremove) %>% # remove features with 0 variance
  dplyr::select(sample_name, treatment, mz_rt, rel_abund) %>%
  group_by(mz_rt) %>%
  wilcox_test(rel_abund ~ treatment, 
         paired = FALSE, 
         detailed = TRUE, # gives you more detail in output
         p.adjust.method = "BH") %>% # Benjamini-Hochberg false discovery rate multiple testing correction
  add_significance() %>%
  arrange(p)

# extract out only the significantly different features
MEF_MEF_SS_nonparametric_sig <- MEF_MEF_SS_nonparametric %>%
  filter(p <= 0.05)

# how many features are significantly different between the groups?
nrow(MEF_MEF_SS_nonparametric_sig)
```
### MEF x 40TT_10M

#### Parametric

Getting an error that some data is essential constant, checked for which features have 0 SD across the treatments for comparison.

```{r}
# find which features have no variance across MEF and 40TT_10M
MEF_40TT_10M_novariance <- feature_table_long_log2 %>%
  filter(treatment == "MEF" | treatment == "MT") %>%
  dplyr::select(sample_name, treatment, mz_rt, rel_abund, id) %>%
  group_by(id) %>%
  summarize(stdev = sd(rel_abund),
            mean = mean(rel_abund)) %>%
  filter(stdev == 0)

# create a vector of those features with no variance
MEF_40TT_10M_toremove <- MEF_40TT_10M_novariance$id


# run series of t-tests
MEF_40TT_10M <- feature_table_long_log2 %>%
  filter(treatment == "MEF" | treatment == "MT") %>%
  filter(!mz_rt %in% MEF_40TT_10M_toremove) %>% # remove features with 0 variance
  dplyr::select(sample_name, treatment, mz_rt, rel_abund, id) %>%
  group_by(id) %>%
  t_test(rel_abund ~ treatment, 
         paired = FALSE, 
         detailed = TRUE, # gives you more detail in output
         p.adjust.method = "BH") %>% # bonferroni or Benjamini-Hochberg false discovery rate multiple testing correction
  add_significance()

# extract out only the significantly different features
MEF_40TT_10M_bonferroni <- MEF_40TT_10M %>%
  filter(p <= 0.05)

# how many features are significantly different between the groups?
nrow(MEF_40TT_10M_bonferroni)
```

#### Volcano plot

Wrangling

```{r}
MEF_40TT_10M_FC <- feature_table_long_log2 %>%
  filter(treatment == "MEF" | treatment == "MT") %>%
  group_by(treatment, id) %>%
  summarize(mean = mean(rel_abund)) %>%
  pivot_wider(names_from = treatment, values_from = mean) %>%
  mutate(MEF_minus_40TT_10M_log2 = `MEF`-`MT`)

MEF_40TT_10M_FC_pval <- right_join(MEF_40TT_10M_FC, MEF_40TT_10M, by = "id") %>%
  mutate(neglog10p = -log10(p))
```

Looking at features that are at least 2 fold change between groups and significantly different at p<0.05.
```{r}
higher_MEF <- MEF_40TT_10M_FC_pval %>%
  filter(neglog10p >= 1.3 & MEF_minus_40TT_10M_log2 >= 1)

higher_40TT_10M <- MEF_40TT_10M_FC_pval %>%
  filter(neglog10p >= 1.3 & MEF_minus_40TT_10M_log2 <= -1)

(MEF_40TT_10M_volcano <- MEF_40TT_10M_FC_pval %>%
  ggplot(aes(x = MEF_minus_40TT_10M_log2, y = neglog10p, text = id)) +
  geom_point() +
  geom_point(data = higher_MEF, 
             aes(x = MEF_minus_40TT_10M_log2, y = neglog10p),
             color = "red") +
  geom_point(data = higher_40TT_10M, 
             aes(x = MEF_minus_40TT_10M_log2, y = neglog10p),
             color = "blue") +
  geom_hline(yintercept = 1.3, linetype = "dashed") +
  geom_vline(xintercept = -1, linetype = "dashed") +
  geom_vline(xintercept = 1, linetype = "dashed") +
  coord_cartesian(xlim = c(-8,8)) +
  theme_minimal(base_size = 8) +
  labs(x = "-log2(fold change)", base_size = 8,
       y = "-log10(p-value)", base_size = 8,
       title = "MEF vs MT", tag = "B", base_size = 8))

```

Make interactive.
```{r}
ggplotly(MEF_40TT_10M_volcano, tooltip = "text")
```


Saving higher_MEF and higher_40TT_10M files

```{r}
write_csv(higher_MEF,
          "pos_higher_MEF_versus_40TT_10M.csv")

write_csv(higher_40TT_10M,
          "pos_higher_40TT_10M_versus_MEF.csv")
```

#### Non-parametric

Data might not be normally distributed so I did a nonparametric test.

```{r}

# run series of t-tests
MEF_40TT_10M_nonparametric <- feature_table_long_log2 %>%
  filter(treatment == "MEF" | treatment == "MT") %>%
  filter(!mz_rt %in% MEF_40TT_10M_toremove) %>% # remove features with 0 variance
  dplyr::select(sample_name, treatment, mz_rt, rel_abund) %>%
  group_by(mz_rt) %>%
  wilcox_test(rel_abund ~ treatment, 
         paired = FALSE, 
         detailed = TRUE, # gives you more detail in output
         p.adjust.method = "BH") %>% # Benjamini-Hochberg false discovery rate multiple testing correction
  add_significance() %>%
  arrange(p)

# extract out only the significantly different features
MEF_40TT_10M_nonparametric_sig <- MEF_40TT_10M_nonparametric %>%
  filter(p <= 0.05)

# how many features are significantly different between the groups?
nrow(MEF_40TT_10M_nonparametric_sig)
```

### MEF_SS x 40TT_10M

#### Parametric

Getting an error that some data is essential constant, checked for which features have 0 SD across the treatments for comparison.

```{r}
# find which features have no variance across MEF_SS and 40TT_10M
MEF_SS_40TT_10M_novariance <- feature_table_long_log2 %>%
  filter(treatment == "MEF_SS" | treatment == "MT") %>%
  dplyr::select(sample_name, treatment, mz_rt, rel_abund, id) %>%
  group_by(id) %>%
  summarize(stdev = sd(rel_abund),
            mean = mean(rel_abund)) %>%
  filter(stdev == 0)

# create a vector of those features with no variance
MEF_SS_40TT_10M_toremove <- MEF_SS_40TT_10M_novariance$id


# run series of t-tests
MEF_SS_40TT_10M <- feature_table_long_log2 %>%
  filter(treatment == "MEF+SS" | treatment == "MT") %>%
  filter(!mz_rt %in% MEF_SS_40TT_10M_toremove) %>% # remove features with 0 variance
  dplyr::select(sample_name, treatment, mz_rt, rel_abund, id) %>%
  group_by(id) %>%
  t_test(rel_abund ~ treatment, 
         paired = FALSE, 
         detailed = TRUE, # gives you more detail in output
         p.adjust.method = "bonferroni") %>% # bonferroni or Benjamini-Hochberg false discovery rate multiple testing correction
  add_significance()

# extract out only the significantly different features
MEF_SS_40TT_10M_bonferroni <- MEF_SS_40TT_10M %>%
  filter(p <= 0.05)

# how many features are significantly different between the groups?
nrow(MEF_SS_40TT_10M_bonferroni)
```

#### Volcano plot

Wrangling

```{r}
MEF_SS_40TT_10M_FC <- feature_table_long_log2 %>%
  filter(treatment == "MEF+SS" | treatment == "MT") %>%
  group_by(treatment, id) %>%
  summarize(mean = mean(rel_abund)) %>%
  pivot_wider(names_from = treatment, values_from = mean) %>%
  mutate(MEF_SS_minus_40TT_10M_log2 = `MEF+SS`-`MT`)

MEF_SS_40TT_10M_FC_pval <- right_join(MEF_SS_40TT_10M_FC, MEF_SS_40TT_10M, by = "id") %>%
  mutate(neglog10p = -log10(p))
```

Looking at features that are at least 2 fold change between groups and significantly different at p<0.05.
```{r}
higher_MEF_SS <- MEF_SS_40TT_10M_FC_pval %>%
  filter(neglog10p >= 1.3 & MEF_SS_minus_40TT_10M_log2 >= 1)

higher_40TT_10M <- MEF_SS_40TT_10M_FC_pval %>%
  filter(neglog10p >= 1.3 & MEF_SS_minus_40TT_10M_log2 <= -1)

(MEF_SS_40TT_10M_volcano <- MEF_SS_40TT_10M_FC_pval %>%
  ggplot(aes(x = MEF_SS_minus_40TT_10M_log2, y = neglog10p, text = id)) +
  geom_point() +
  geom_point(data = higher_MEF_SS, 
             aes(x = MEF_SS_minus_40TT_10M_log2, y = neglog10p),
             color = "red") +
  geom_point(data = higher_40TT_10M, 
             aes(x = MEF_SS_minus_40TT_10M_log2, y = neglog10p),
             color = "blue") +
  geom_hline(yintercept = 1.3, linetype = "dashed") +
  geom_vline(xintercept = -1, linetype = "dashed") +
  geom_vline(xintercept = 1, linetype = "dashed") +
  coord_cartesian(xlim = c(-8,8)) +
  theme_minimal(base_size = 8) +
  labs(x = "-log2(fold change)", base_size = 8,
       y = "-log10(p-value)", base_size = 8,
       title = "MEF+SS vs MT", tag = "B", base_size = 8))

```

Make interactive.
```{r}
ggplotly(MEF_SS_40TT_10M_volcano, tooltip = "text")
```


Saving higher_MEF_SS and higher_40TT_10M files

```{r}
write_csv(higher_MEF_SS,
          "pos_higher_MEF_SS_versus_40TT_10M.csv")

write_csv(higher_40TT_10M,
          "pos_higher_40TT_10M_versus_MEF_SS.csv")
```


#### Non-parametric

Data might not be normally distributed so I did a nonparametric test.

```{r}

# run series of t-tests
MEF_SS_40TT_10M_nonparametric <- feature_table_long_log2 %>%
  filter(treatment == "MEF+SS" | treatment == "MT") %>%
  filter(!mz_rt %in% MEF_SS_40TT_10M_toremove) %>% # remove features with 0 variance
  dplyr::select(sample_name, treatment, mz_rt, rel_abund) %>%
  group_by(mz_rt) %>%
  wilcox_test(rel_abund ~ treatment, 
         paired = FALSE, 
         detailed = TRUE, # gives you more detail in output
         p.adjust.method = "BH") %>% # Benjamini-Hochberg false discovery rate multiple testing correction
  add_significance() %>%
  arrange(p)

# extract out only the significantly different features
MEF_SS_40TT_10M_nonparametric_sig <- MEF_SS_40TT_10M_nonparametric %>%
  filter(p <= 0.05)

# how many features are significantly different between the groups?
nrow(MEF_SS_40TT_10M_nonparametric_sig)
```


### Freshjuice x 40TT_10M

#### Parametric

Getting an error that some data is essential constant, checked for which features have 0 SD across the treatments for comparison.

```{r}
# find which features have no variance across freshjuice and 40TT_10M
freshjuice_40TT_10M_novariance <- feature_table_long_log2 %>%
  filter(treatment == "Fresh Juice" | treatment == "MT") %>%
  dplyr::select(sample_name, treatment, mz_rt, rel_abund, id) %>%
  group_by(id) %>%
  summarize(stdev = sd(rel_abund),
            mean = mean(rel_abund)) %>%
  filter(stdev == 0)

# create a vector of those features with no variance
freshjuice_40TT_10M_toremove <- freshjuice_40TT_10M_novariance$id


# run series of t-tests
freshjuice_40TT_10M <- feature_table_long_log2 %>%
  filter(treatment == "FJ" | treatment == "MT") %>%
  filter(!mz_rt %in% freshjuice_40TT_10M_toremove) %>% # remove features with 0 variance
  dplyr::select(sample_name, treatment, mz_rt, rel_abund, id) %>%
  group_by(id) %>%
  t_test(rel_abund ~ treatment, 
         paired = FALSE, 
         detailed = TRUE, # gives you more detail in output
         p.adjust.method = "BH") %>% # bonferroni or Benjamini-Hochberg false discovery rate multiple testing correction
  add_significance()

# extract out only the significantly different features
freshjuice_40TT_10M_bonferroni <- freshjuice_40TT_10M %>%
  filter(p <= 0.05)

# how many features are significantly different between the groups?
nrow(freshjuice_40TT_10M_bonferroni)
```

#### Volcano plot

Wrangling

```{r}
freshjuice_40TT_10M_FC <- feature_table_long_log2 %>%
  filter(treatment == "FJ" | treatment == "MT") %>%
  group_by(treatment, id) %>%
  summarize(mean = mean(rel_abund)) %>%
  pivot_wider(names_from = treatment, values_from = mean) %>%
  mutate(freshjuice_minus_40TT_10M_log2 = `FJ`-`MT`)

freshjuice_40TT_10M_FC_pval <- right_join(freshjuice_40TT_10M_FC, freshjuice_40TT_10M, by = "id") %>%
  mutate(neglog10p = -log10(p))
```

Looking at features that are at least 2 fold change between groups and significantly different at p<0.05.
```{r}
higher_freshjuice <- freshjuice_40TT_10M_FC_pval %>%
  filter(neglog10p >= 1.3 & freshjuice_minus_40TT_10M_log2 >= 1)

higher_40TT_10M <- freshjuice_40TT_10M_FC_pval %>%
  filter(neglog10p >= 1.3 & freshjuice_minus_40TT_10M_log2 <= -1)

(freshjuice_40TT_10M_volcano <- freshjuice_40TT_10M_FC_pval %>%
  ggplot(aes(x = freshjuice_minus_40TT_10M_log2, y = neglog10p, text = id)) +
  geom_point() +
  geom_point(data = higher_freshjuice, 
             aes(x = freshjuice_minus_40TT_10M_log2, y = neglog10p),
             color = "red") +
  geom_point(data = higher_40TT_10M, 
             aes(x = freshjuice_minus_40TT_10M_log2, y = neglog10p),
             color = "blue") +
  geom_hline(yintercept = 1.3, linetype = "dashed") +
  geom_vline(xintercept = -1, linetype = "dashed") +
  geom_vline(xintercept = 1, linetype = "dashed") +
  coord_cartesian(xlim = c(-8,8)) +
  theme_minimal(base_size = 8) +
  labs(x = "-log2(fold change)", base_size = 8,
       y = "-log10(p-value)", base_size = 8,
       title = "FJ vs MT", tag = "B", base_size = 8))
```

Make interactive.
```{r}
ggplotly(freshjuice_40TT_10M_volcano, tooltip = "text")
```


Saving higher_freshjuice and higher_40TT_10M files

```{r}
write_csv(higher_freshjuice,
          "pos_higher_freshjuice_versus_40TT_10M.csv")

write_csv(higher_40TT_10M,
          "pos_higher_40TT_10M_versus_freshjuice.csv")
```


#### Non-parametric

Data might not be normally distributed so I did a nonparametric test.

```{r}

# run series of t-tests
freshjuice_40TT_10M_nonparametric <- feature_table_long_log2 %>%
  filter(treatment == "FJ" | treatment == "MT") %>%
  filter(!mz_rt %in% freshjuice_40TT_10M_toremove) %>% # remove features with 0 variance
  dplyr::select(sample_name, treatment, mz_rt, rel_abund) %>%
  group_by(mz_rt) %>%
  wilcox_test(rel_abund ~ treatment, 
         paired = FALSE, 
         detailed = TRUE, # gives you more detail in output
         p.adjust.method = "BH") %>% # Benjamini-Hochberg false discovery rate multiple testing correction
  add_significance() %>%
  arrange(p)

# extract out only the significantly different features
freshjuice_40TT_10M_nonparametric_sig <- freshjuice_40TT_10M_nonparametric %>%
  filter(p <= 0.05)

# how many features are significantly different between the groups?
nrow(freshjuice_40TT_10M_nonparametric_sig)
```


```{r}
volcano_plot <- (freshjuice_MEF_volcano + freshjuice_MEF_SS_volcano) / (MEF_MEF_SS_volcano + MEF_40TT_10M_volcano) / (MEF_SS_40TT_10M_volcano + freshjuice_40TT_10M_volcano)

ggsave(plot = volcano_plot,
       filename = "volcano_plot_final_pos.jpeg", width = 190, height = 190, units = "mm")

```

## Heatmap of all features

```{r}
head(feature_table_wide_log2)
```


```{r}
unique(feature_table_wide_log2$treatment)
```

```{r}
# find which features have no variance across fresh juice and MEF
# having samples with no variance won't work for a heatmap
all_MEF_comparisons_novariance <- feature_table_long_log2 %>%
  filter(sample_or_qc == "Sample") %>% # samples only
  dplyr::select(sample_name, treatment, mz_rt, rel_abund, id) %>%
  group_by(id) %>%
  summarize(stdev = sd(rel_abund),
            mean = mean(rel_abund)) %>%
  filter(stdev == 0)

# what features have no variance?
all_MEF_comparisons_novariance$id
```


```{r}
# wrangle
feature_table_MEF_for_heatmap <- feature_table_wide_log2 %>%
  filter(sample_or_qc == "Sample") %>% # samples only
  select(-`147.0352_4.5939`, -`158.0271_4.5932`, -`214.0896_4.5925`, -`220.1461_1.7441`, -`289.1643_5.498`,  -`360.2511_5.6451`, -`365.1933_5.6428`, -`474.3058_6.3948`, -`588.3738_6.9782`, -`614.5224_6.7997`) %>% # remove features with no variance
  select(-run_order, -sample_or_qc) %>% # remove columns we don't need
  column_to_rownames(var = "sample_name") # move the sample names to rownames for plotting


heatmap <- pheatmap(feature_table_MEF_for_heatmap[,-1], # remove treatment column
         cluster_rows = TRUE, # HCA on samples
         cluster_cols = TRUE, # HCA on features 
         scale = "column",
         legend_breaks = c(-4, 0, 4),
         legend_labels = c('Low concentration', 'Medium concentration', 'High concentration'),
         border_color = F,
         show_colnames = FALSE, # scale for each feature
         filename = "heatmap_pos.png")
```


## ANOVA across groups

```{r}
anova <- feature_table_long_log2 %>%
  filter(!sample_or_qc == "QC") %>% # remove QCs
  dplyr::select(sample_name, treatment, mz_rt, rel_abund) %>%
  group_by(mz_rt) %>%
 # Remove grupos onde todos os valores de rel_abund sÃ£o iguais
  filter(n_distinct(rel_abund) > 1) %>%
  anova_test(rel_abund ~ treatment)

# adjust pvalues for multiple testing
anova_padjusted <- p.adjust(anova$p, method = "BH") %>%
  as.data.frame() %>%
  rename(p_adj = 1)

anova_padj <- bind_cols(as.data.frame(anova), anova_padjusted) %>%
  rename(padj = 9)

# extract out only the significantly different features
anova_sig <- anova_padj %>%
  as.data.frame() %>%
  filter(p <= 0.05)

# how many features are significantly different between the groups?
nrow(anova_sig)
```

## Heatmap of features that are different between groups

```{r}
feature_table_long_log2_anova <- inner_join(feature_table_long_log2, anova_sig, by = "mz_rt") %>%
   select(sample_name, treatment, sample_or_qc, mz_rt, rel_abund, id)
  
unique(feature_table_long_log2$id)

```

```{r}
# find which features have no variance across fresh juice and MEF
# having samples with no variance won't work for a heatmap
all_MEF_comparisons_novariance <- feature_table_long_log2_anova %>%
  filter(sample_or_qc == "Sample") %>% # samples only
  dplyr::select(sample_name, treatment, mz_rt, rel_abund, id) %>%
  group_by(id) %>%
  summarize(stdev = sd(rel_abund),
            mean = mean(rel_abund)) %>%
  filter(stdev == 0)

# what features have no variance?
all_MEF_comparisons_novariance$id
```
```{r}
# wrangle

feature_table_wide_log2_anova <- feature_table_long_log2_anova %>%
  select(-"id")  %>%
  pivot_wider(names_from = "mz_rt",
              values_from = "rel_abund")


feature_table_MEF_anova_for_heatmap <- feature_table_wide_log2_anova %>%
  filter(sample_or_qc == "Sample") %>% # samples only
  select(-sample_or_qc) %>% # remove columns we don't need
  column_to_rownames(var = "sample_name") # move the sample names to rownames for plotting


heatmap <- pheatmap(feature_table_MEF_anova_for_heatmap[,-1], # remove treatment column
         cluster_rows = TRUE, # HCA on samples
         cluster_cols = TRUE, # HCA on features 
         scale = "column",
         show_colnames = FALSE, # scale for each feature
         legend_breaks = c(-4, 0, 4),
         legend_labels = c('Low concentration', 'Medium concentration', 'High concentration'),
         border_color = F,
         filename = "heatmap_anova_pos.png")
```
```{r}
ncol(feature_table_MEF_for_heatmap)
```

```{r}
ncol(feature_table_MEF_anova_for_heatmap)
```

